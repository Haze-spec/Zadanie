1. CVE-2023-22515 - это уязвимость типа **"Server-Side Request Forgery (SSRF)"**, 
Ключевой момент атаки заключается в том, что уязвимые версии Confluence Data Center и Confluence Server позволяют без аутентификации на сервере поменять значение атрибута  bootstrapStatusProvider.applicationConfig.setupComplete на  false . Тем самым атакующие реинициализируют этап начальной настройки сервера и получают возможность бесконтрольно создавать на нем собственные учетные записи администраторов.

**Механизм уязвимости:**

1.1 **Некорректная обработка URL:**  Уязвимость возникает, когда злоумышленник может ввести специально сформированный URL в поле ввода веб-формы, которая отправляет HTTP-запрос.
1.2 **Запрос к внутренним серверам:**  Вместо отправки запроса на внешний сервер, Content Formatter отправляет запрос на внутренний сервер, например, на сервер базы данных или на сервер приложений.
1.3 **Проникновение в систему:**  Злоумышленник может использовать эту возможность для получения доступа к конфиденциальной информации, перехватить сеансы аутентификации, управлять сервером, а также получить доступ к внутренним сетям.


**список уязвимых версий по информации, опубликованной Atlassian**

8.0.0, 8.0.1, 8.0.2, 8.0.3, 8.0.4;
8.1.0, 8.1.1, 8.1.3, 8.1.4;
8.2.0, 8.2.1, 8.2.2, 8.2.3;
8.3.0, 8.3.1, 8.3.2;
8.4.0, 8.4.1, 8.4.2;
8.5.0, 8.5.1.

2. **NSE скрипт для Nmap**

2.1 `#!/usr/bin/env python`:  Определяет интерпретатор  Python  для  скрипта.
2.2 `import nmap`:  Импортирует  библиотеку  `nmap`  для  работы  с  Nmap.
2.3 `check_cve_2023_22515(tgt)`:
    * Принимает  URL-адрес  целевого  сервера  Confluence  в  качестве  аргумента  `tgt`.
    * Использует  `nmap.http.request`  для  отправки  HTTP-запроса  к  серверу.
    * Извлекает  версию  Confluence  из  заголовка  `X-Confluence-Version`.
    * Проверяет  уязвимость  по  версии  Confluence  (8.0.0 - 8.5.1).
    * Возвращает  `True`,  если  уязвимость  обнаружена,  `False`  в  противном  случае.
2.4 `main()`:
    * Устанавливает  `tgt`  как  URL-адрес  целевого  сервера  Confluence.
    * Вызывает  `check_cve_2023_22515(tgt)`  для  проверки  уязвимости.
2.5 `if __name__ == '__main__':`:  Запускает  `main()`,  если  скрипт  запущен  непосредственно,  а  не  импортирован  как  модуль.

3. **Простой и быстрый способ протестировать работу скрипта**


3.1 Запустите  Docker  Compose  для  создания  тестовой  среды  Confluence
3.2 Запустите  Nmap  с  использованием  скрипта(cve_2023_22515.nse ):
   
   nmap -sV -p 8090 -iL target.txt -script cve_2023_22515.nse 
   
    * `-sV`:  Определяет  версию  сервиса,  работающего  на  сканируемом  порте.
    * `-p 8090`:  Сканирует  только  порт  8090  (стандартный  порт  для  Confluence).
    * `-iL target.txt`:  Указывает  файл  `target.txt`  с  IP-адресом  контейнера  `confluence_vulnerable`.  В  файле  `target.txt`  должен  быть  только  IP-адрес  контейнера.

4. **Скрытие уязвимости**

Администратор может попытаться скрыть уязвимость следующими способами:

* **Обновление Confluence Server:**  Установка последнего патча, который исправляет CVE-2023-22515, является лучшим способом защититься от этой уязвимости.
* **Блокировка HTTP-запросов с заголовком "User-Agent: Confluence":**  Админ может настроить веб-сервер, чтобы блокировать запросы с указанным заголовком.
* **Ограничение доступа к веб-серверу:** Ограничение доступа к Confluence Server только для доверенных пользователей может предотвратить злонамеренные атаки.
* **Использование WAF:**  Использование веб-приложения для защиты от атак (WAF) для блокировки вредоносных запросов.